<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Users â€¢ Admin Panel</title>
  <link rel="stylesheet" href="/styles/dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  </head>
<body>
  <%- include('partials/navbar') %>

  <div class="admin-users-container">
    <h2 class="section-header">ðŸ‘¥ Manage Users</h2>

    <% if (message) { %>
      <div class="message-success"><%= message %></div>
    <% } %>
    <% if (error) { %>
      <div class="message-error"><%= error %></div>
    <% } %>

    <div class="table-responsive-wrapper">
      <% if (allUsers && allUsers.length > 0) { %>
        <table class="user-table">
          <thead>
            <tr>
              <th>Profile</th>
              <th>Email</th>
              <th>Name</th>
              <th>Role</th>
              <th>Joined</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% allUsers.forEach(userItem => { %>
              <tr>
                <td><img src="<%= userItem.profilePicture || '/images/default_image.png' %>" alt="<%= userItem.username %>"></td>
                <td><%= userItem.email %></td>
                <td><%= userItem.firstName || '' %> <%= userItem.lastName || '' %></td>
                <td>
                  <form action="/admin/users/update-role/<%= userItem._id %>" method="POST">
                    <select name="newRole">
                      <option value="user" <%= userItem.role === 'user' ? 'selected' : '' %>>User</option>
                      <option value="admin" <%= userItem.role === 'admin' ? 'selected' : '' %>>Admin</option>
                    </select>
                    <button type="submit" class="update-btn">Update</button>
                  </form>
                </td>
                <td><%= new Date(userItem.createdAt).toLocaleDateString() %></td>
                <td>
                  <% if (user && user._id && userItem._id && user._id.toString() !== userItem._id.toString()) { %>
                    <form action="/admin/users/delete/<%= userItem._id %>" method="POST" onsubmit="return confirm('Are you sure you want to delete <%= userItem.email %>? This action cannot be undone.');">
                      <button type="submit" class="delete-btn">Delete</button>
                    </form>
                  <% } else { %>
                    <button class="delete-btn" disabled title="Cannot delete your own account">Delete</button>
                  <% } %>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      <% } else { %>
        <div class="no-users">No users found in the system.</div>
      <% } %>
    </div>

    <a href="/admin/dashboard" class="back-to-admin">
      <i class="fas fa-arrow-left"></i> Back to Admin Dashboard
    </a>
  </div>

  <%- include('partials/footer') %>
</body>
</html>