<!DOCTYPE html>
<html>
<head>
Â  <meta charset="UTF-8">
Â  <title>Upload Bill â€¢ MyGreenHome</title>
Â  <link rel="stylesheet" href="/styles/dashboard.css">
Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
Â  <style>
Â  Â  .dashboard-container {
Â  Â  Â  display: flex;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  gap: 20px;
Â  Â  Â  padding: 20px;
Â  Â  }
Â  Â  .upload-section {
Â  Â  Â  flex: 2;
Â  Â  Â  min-width: 300px;
Â  Â  Â  background: white;
Â  Â  Â  padding: 20px;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .results-section {
Â  Â  Â  flex: 1;
Â  Â  Â  min-width: 280px;
Â  Â  Â  background: #f9f9f9;
Â  Â  Â  padding: 15px;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
Â  Â  }
Â  Â  #previewImage {
Â  Â  Â  margin-top: 15px;
Â  Â  Â  max-width: 100%;
Â  Â  Â  max-height: 200px;
Â  Â  Â  display: none;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  border-radius: 8px;
Â  Â  }
Â  Â  .file-name-display {
Â  Â  Â  margin-top: 8px;
Â  Â  Â  font-size: 14px;
Â  Â  Â  color: #555;
Â  Â  }
Â  Â  .error-msg {
Â  Â  Â  color: red;
Â  Â  Â  font-size: 14px;
Â  Â  }
Â  Â  .result-card {
Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  padding: 10px;
Â  Â  Â  background: white;
Â  Â  Â  border-left: 6px solid #2ecc71;
Â  Â  Â  border-radius: 6px;
Â  Â  }
Â  Â  .tips-box {
Â  Â  Â  margin-top: 20px;
Â  Â  Â  padding: 15px;
Â  Â  Â  background: #fff9e6;
Â  Â  Â  border-left: 6px solid #f39c12;
Â  Â  Â  border-radius: 8px;
Â  Â  }
Â  Â  .tips-box ul {
Â  Â  Â  padding-left: 20px;
Â  Â  }
Â  Â  .tips-box li {
Â  Â  Â  margin-bottom: 8px;
Â  Â  }
Â  Â  .no-analysis {
Â  Â  Â  background: #f8f8f8;
Â  Â  Â  padding: 20px;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  text-align: center;
Â  Â  Â  font-style: italic;
Â  Â  Â  color: #777;
Â  Â  }
    .tracking-link-btn {
        display: block;
        width: fit-content;
        margin: 20px auto 0;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        text-align: center;
        border-radius: 5px;
        text-decoration: none;
        font-size: 16px;
        transition: background-color 0.3s ease;
    }
    .tracking-link-btn:hover {
        background-color: #0056b3;
    }
Â  </style>
</head>
<body>
Â  <div class="top-bar">
Â  Â  <button onclick="location.href='/dashboard/home'">
Â  Â  Â  <i class="fas fa-house"></i> Home
Â  Â  </button>
Â  Â  <h2>ğŸ” Analyze Your Electricity Bill</h2>
Â  Â  <button onclick="location.href='/dashboard/logout'">
Â  Â  Â  <i class="fas fa-right-from-bracket"></i> Logout
Â  Â  </button>
Â  </div>

Â  <div class="dashboard-container">
Â  Â  Â  Â  <div class="upload-section">
Â  Â  Â  <h3>ğŸ“¤ Upload a New Bill</h3>
Â  Â  Â  <form id="uploadForm" action="/dashboard/analyze" method="POST" enctype="multipart/form-data">
Â  Â  Â  Â  <input type="file" name="photo" id="fileInput" accept="image/*" required hidden>
Â  Â  Â  Â  <div id="dropZone" class="file-uploader">
Â  Â  Â  Â  Â  <div class="file-placeholder">
Â  Â  Â  Â  Â  Â  Drag & drop or click to select an image (JPG, PNG, max 5MB)
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="fileName" class="file-name-display">No file selected</div>
Â  Â  Â  Â  Â  <img id="previewImage" src="#" alt="Preview" />
Â  Â  Â  Â  Â  <p id="errorMsg" class="error-msg"></p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="progressContainer" class="upload-progress">
Â  Â  Â  Â  Â  <div id="progressBar" class="progress-bar"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <button id="submitBtn" type="submit" disabled>
Â  Â  Â  Â  Â  <i class="fas fa-magnifying-glass-chart"></i> Analyze Bill
Â  Â  Â  Â  </button>
Â  Â  Â  </form>

Â  Â  Â  <% if (tips && tips.length > 0) { %>
Â  Â  Â  <div class="tips-box">
Â  Â  Â  Â  <h4>ğŸ’¡ Power-Saving Tips:</h4>
Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  <% tips.forEach(tip => { %>
Â  Â  Â  Â  Â  Â  <li><%= tip %></li>
Â  Â  Â  Â  Â  <% }) %>
Â  Â  Â  Â  </ul>
Â  Â  Â  </div>
Â  Â  Â  <% } %>
Â  Â  </div>

Â  Â  Â  Â  <div class="results-section">
Â  Â  Â  <h4>ğŸ“Š Last Analysis Summary</h4>

Â  Â  Â  <% if (user && user.lastResult && user.lastResult.totalConsumption !== undefined) { %>
Â  Â  Â  Â  <div class="result-card">
Â  Â  Â  Â  Â  <strong>Total Consumption:</strong><br/>
Â  Â  Â  Â  Â  <%= user.lastResult.totalConsumption %> kWh
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="result-card">
Â  Â  Â  Â  Â  <strong>COâ‚‚ Emissions:</strong><br/>
Â  Â  Â  Â  Â  <%= user.lastResult.carbonKg %> kg/month
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="result-card">
Â  Â  Â  Â  Â  <strong>Bill Amount:</strong><br/>
Â  Â  Â  Â  Â  â‚¹<%= user.lastResult.totalAmount.toFixed(2) %>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="result-card" style="border-left-color: #f39c12;">
Â  Â  Â  Â  Â  <strong>Tip:</strong><br/>
Â  Â  Â  Â  Â  <%= user.lastResult.savingsTip %>
Â  Â  Â  Â  </div>
Â  Â  Â  <% } else { %>
Â  Â  Â  Â  <div class="no-analysis">
Â  Â  Â  Â  Â  âš ï¸ No analysis yet. Upload a bill to see results here.
Â  Â  Â  Â  </div>
Â  Â  Â  <% } %>

      <a href="/dashboard/tracking" class="tracking-link-btn">View Historical Tracking & Comparison</a>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  const fileInput = document.getElementById('fileInput');
Â  Â  const dropZone = document.getElementById('dropZone');
Â  Â  const fileNameDisplay = document.getElementById('fileName');
Â  Â  const submitBtn = document.getElementById('submitBtn');
Â  Â  const previewImage = document.getElementById('previewImage');
Â  Â  const errorMsg = document.getElementById('errorMsg');
Â  Â  const uploadForm = document.getElementById('uploadForm');
Â  Â  const progressBar = document.getElementById('progressBar');
Â  Â  const progressContainer = document.getElementById('progressContainer');

Â  Â  dropZone.addEventListener('click', () => fileInput.click());

Â  Â  fileInput.addEventListener('change', () => {
Â  Â  Â  const file = fileInput.files[0];
Â  Â  Â  if (!file) return;

Â  Â  Â  if (!file.type.startsWith('image/')) {
Â  Â  Â  Â  errorMsg.textContent = "Please upload an image file only.";
Â  Â  Â  Â  fileInput.value = '';
Â  Â  Â  Â  previewImage.style.display = 'none';
Â  Â  Â  Â  submitBtn.disabled = true;
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  if (file.size > 5 * 1024 * 1024) {
Â  Â  Â  Â  errorMsg.textContent = "Image too large. Max 5MB allowed.";
Â  Â  Â  Â  fileInput.value = '';
Â  Â  Â  Â  previewImage.style.display = 'none';
Â  Â  Â  Â  submitBtn.disabled = true;
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  errorMsg.textContent = "";
Â  Â  Â  fileNameDisplay.textContent = file.name;
Â  Â  Â  submitBtn.disabled = false;

Â  Â  Â  const reader = new FileReader();
Â  Â  Â  reader.onload = e => {
Â  Â  Â  Â  previewImage.src = e.target.result;
Â  Â  Â  Â  previewImage.style.display = 'block';
Â  Â  Â  };
Â  Â  Â  reader.readAsDataURL(file);
Â  Â  });

Â  Â  ['dragover', 'dragenter'].forEach(evt => {
Â  Â  Â  dropZone.addEventListener(evt, e => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  dropZone.classList.add('dragover');
Â  Â  Â  });
Â  Â  });

Â  Â  ['dragleave', 'drop'].forEach(evt => {
Â  Â  Â  dropZone.addEventListener(evt, e => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  dropZone.classList.remove('dragover');
Â  Â  Â  });
Â  Â  });

Â  Â  dropZone.addEventListener('drop', e => {
Â  Â  Â  e.preventDefault();
Â  Â  Â  fileInput.files = e.dataTransfer.files;
Â  Â  Â  fileInput.dispatchEvent(new Event('change'));
Â  Â  });

Â  Â  uploadForm.addEventListener('submit', e => {
Â  Â  Â  e.preventDefault();
Â  Â  Â  const formData = new FormData(uploadForm);
Â  Â  Â  const xhr = new XMLHttpRequest();
Â  Â  Â  xhr.open('POST', uploadForm.action, true);

Â  Â  Â  xhr.upload.onprogress = event => {
Â  Â  Â  Â  if (event.lengthComputable) {
Â  Â  Â  Â  Â  const percent = (event.loaded / event.total) * 100;
Â  Â  Â  Â  Â  progressContainer.style.display = 'block';
Â  Â  Â  Â  Â  progressBar.style.width = percent + '%';
Â  Â  Â  Â  Â  progressBar.textContent = Math.floor(percent) + '%';
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  xhr.onload = () => {
Â  Â  Â  Â  if (xhr.status === 200) {
Â  Â  Â  Â  Â  location.reload();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  errorMsg.textContent = 'Upload failed. Try again.';
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  xhr.send(formData);
Â  Â  });
Â  </script>
</body>
</html>