<!DOCTYPE html>
<html>

<head>
    Â 
    <meta charset="UTF-8">
    Â  <title>Upload Bill â€¢ MyGreenHome</title>
    Â 
    <link rel="stylesheet" href="/styles/dashboard.css">
    Â 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    Â  <style>
        .dashboard-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
        }

        .upload-section {
            flex: 2;
            min-width: 300px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .results-section {
            flex: 1;
            min-width: 280px;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        #previewImage {
            margin-top: 15px;
            max-width: 100%;
            max-height: 200px;
            display: none;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        .file-name-display {
            margin-top: 8px;
            font-size: 14px;
            color: #555;
        }

        .error-msg {
            color: red;
            font-size: 14px;
        }

        .result-card {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-left: 6px solid #2ecc71;
            border-radius: 6px;
        }

        .tips-box {
            margin-top: 20px;
            padding: 15px;
            background: #fff9e6;
            border-left: 6px solid #f39c12;
            border-radius: 8px;
        }

        .tips-box ul {
            padding-left: 20px;
        }

        .tips-box li {
            margin-bottom: 8px;
        }

        .no-analysis {
            background: #f8f8f8;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-style: italic;
            color: #777;
        }

        .tracking-link-btn {
            display: block;
            width: fit-content;
            margin: 20px auto 0;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            text-align: center;
            border-radius: 5px;
            text-decoration: none;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .tracking-link-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>
    Â  <%- include('partials/navbar') %>

        Â  <div class="dashboard-container">
            Â  Â  Â  Â  <div class="upload-section">
                Â  Â  Â  <h3>ğŸ“¤ Upload a New Bill</h3>
                Â  Â  Â  <form id="uploadForm" action="/dashboard/analyze" method="POST" enctype="multipart/form-data">
                    Â  Â  Â  Â  <input type="file" name="photo" id="fileInput" accept="image/*" required hidden>
                    Â  Â  Â  Â  <div id="dropZone" class="file-uploader">
                        Â  Â  Â  Â  Â  <div class="file-placeholder">
                            Â  Â  Â  Â  Â  Â  Drag & drop or click to select an image (JPG, PNG, max 5MB)
                            Â  Â  Â  Â  Â  </div>
                        Â  Â  Â  Â  Â  <div id="fileName" class="file-name-display">No file selected</div>
                        Â  Â  Â  Â  Â  <img id="previewImage" src="#" alt="Preview" />
                        Â  Â  Â  Â  Â  <p id="errorMsg" class="error-msg"></p>
                        Â  Â  Â  Â  </div>

                    Â  Â  Â  Â  <div id="progressContainer" class="upload-progress">
                        Â  Â  Â  Â  Â  <div id="progressBar" class="progress-bar"></div>
                        Â  Â  Â  Â  </div>

                    Â  Â  Â  Â  <button id="submitBtn" type="submit" disabled>
                        Â  Â  Â  Â  Â  <i class="fas fa-magnifying-glass-chart"></i> Analyze Bill
                        Â  Â  Â  Â  </button>
                    Â  Â  Â  </form>

                Â  Â  Â  <% if (tips && tips.length> 0) { %>
                    Â  Â  Â  <div class="tips-box">
                        Â  Â  Â  Â  <h4>ğŸ’¡ Power-Saving Tips:</h4>
                        Â  Â  Â  Â  <ul>
                            Â  Â  Â  Â  Â  <% tips.forEach(tip=> { %>
                                Â  Â  Â  Â  Â  Â  <li>
                                    <%= tip %>
                                </li>
                                Â  Â  Â  Â  Â  <% }) %>
                                    Â  Â  Â  Â  </ul>
                        Â  Â  Â  </div>
                    Â  Â  Â  <% } %>
                        Â  Â  </div>

            Â  Â  Â  Â  <div class="results-section">
                Â  Â  Â  <h4>ğŸ“Š Last Analysis Summary</h4>

                Â  Â  Â  <% // Check if there's valid analysis data to display %>
                    Â  Â  Â  <% if (user && user.lastResult && user.lastResult.totalConsumption !==undefined &&
                        user.lastResult.totalConsumption !==0) { %>
                        Â  Â  Â  Â  <div class="result-card">
                            Â  Â  Â  Â  Â  <strong>Total Consumption:</strong><br />
                            Â  Â  Â  Â  Â  <%= user.lastResult.totalConsumption %> kWh
                                Â  Â  Â  Â  </div>
                        Â  Â  Â  Â  <div class="result-card">
                            Â  Â  Â  Â  Â  <strong>COâ‚‚ Emissions:</strong><br />
                            Â  Â  Â  Â  Â  <%= user.lastResult.carbonKg %> kg/month
                                Â  Â  Â  Â  </div>
                        Â  Â  Â  Â  <div class="result-card">
                            Â  Â  Â  Â  Â  <strong>Bill Amount:</strong><br />
                            Â  Â  Â  Â  Â  â‚¹<%= user.lastResult.totalAmount.toFixed(2) %>
                                Â  Â  Â  Â  </div>
                        Â  Â  Â  Â  <div class="result-card" style="border-left-color: #f39c12;">
                            Â  Â  Â  Â  Â  <strong>Tip:</strong><br />
                            Â  Â  Â  Â  Â  <%= user.lastResult.savingsTip %>
                                Â  Â  Â  Â  </div>
                        Â  Â  Â  <% } else { %>
                            Â  Â  Â  Â  <div class="no-analysis">
                                Â  Â  Â  Â  Â  âš ï¸ No analysis yet. Upload your first bill to see results here!
                                Â  Â  Â  Â  </div>
                            Â  Â  Â  <% } %>

                                Â  Â  Â  <a href="/dashboard/tracking" class="tracking-link-btn">View Historical Tracking &
                                    Comparison</a>
                                Â  Â  </div>
            Â  </div>

        Â 
        <script>
            const fileInput = document.getElementById('fileInput');
            const dropZone = document.getElementById('dropZone');
            const fileNameDisplay = document.getElementById('fileName');
            const submitBtn = document.getElementById('submitBtn');
            const previewImage = document.getElementById('previewImage');
            const errorMsg = document.getElementById('errorMsg');
            const uploadForm = document.getElementById('uploadForm');
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressContainer');

            dropZone.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    errorMsg.textContent = "Please upload an image file only.";
                    fileInput.value = '';
                    previewImage.style.display = 'none';
                    submitBtn.disabled = true;
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    errorMsg.textContent = "Image too large. Max 5MB allowed.";
                    fileInput.value = '';
                    previewImage.style.display = 'none';
                    submitBtn.disabled = true;
                    return;
                }

                errorMsg.textContent = "";
                fileNameDisplay.textContent = file.name;
                submitBtn.disabled = false;

                const reader = new FileReader();
                reader.onload = e => {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                };
                reader.readAsDataURL(file);
            });

            ['dragover', 'dragenter'].forEach(evt => {
                dropZone.addEventListener(evt, e => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });
            });

            ['dragleave', 'drop'].forEach(evt => {
                dropZone.addEventListener(evt, e => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                });
            });

            dropZone.addEventListener('drop', e => {
                e.preventDefault();
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            });

            uploadForm.addEventListener('submit', e => {
                e.preventDefault();
                const formData = new FormData(uploadForm);
                const xhr = new XMLHttpRequest();
                xhr.open('POST', uploadForm.action, true);

                xhr.upload.onprogress = event => {
                    if (event.lengthComputable) {
                        const percent = (event.loaded / event.total) * 100;
                        progressContainer.style.display = 'block';
                        progressBar.style.width = percent + '%';
                        progressBar.textContent = Math.floor(percent) + '%';
                    }
                };

                xhr.onload = () => {
                    if (xhr.status === 200) {
                        location.reload();
                    } else {
                        errorMsg.textContent = 'Upload failed. Try again.';
                    }
                };

                xhr.send(formData);
            });
        </script>
</body>

</html>